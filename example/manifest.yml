info:
  name: forgame-api2
  description: API v2
  version: 2.0
  category: site
  owner:
    name: Dmitry Kulikov
    email: kulikov.dm@gmail.com

notify:
  channel: alert-api2

build:
  branch: master
  branch: ^feature-(<branch>.*)
  commands:
    - sbt ';set version := "'${MANIFEST_VERSION}'"' clean test pack && tar -zcf "target/package.tar.gz" -C target/pack/ .

    - marathon:
        package: target/package.tar.gz

    - debian:
        user: innova
        daemon: 
          path: $APPLICATION_PATH/bin/start
          args: |
            -Xmx$("mem_${ENV_NAME}")
            -DSERVICE_NAME=$NAME
            -Dfile.encoding=UTF-8
            -Dconfig.localfile=$APPLICATION_PATH/conf/env.${ENV_NAME}-${AREA_NAME}.conf;$NEW_SECURE_CONFIG_FILE
            -Dlogback.configurationFile=$APPLICATION_PATH/conf/logback.xml
        mem: { qa: 256, live: 512 }
        make_pidfile: yes
        deploy_root: /local/innova/www-versions

    - docker:
      ...

deploy:
  debian:
    cluster:
      qa: graphite.qa.inn.ru
      live: graphite.lux.inn.eu

  marathon:
    routing:
      domain:
        qa: api.4gametest.com go.4gametest.com
        live: api.4game.com go.4game.com
      location: /v2/
    ports: ["http:9024", "jmx:22006"]
    instances: { qa: 1, live: 4 }
    mem: 512
    cpu: 1

alerts:
  - name: RPS
    graphite:
      metric: sumSeries(inn.*.kidzania.api.http.timer.all.m5_rate)
      warn.max: 3000
      crit.max: 4000
      warn: { live: 200 }
      crit: { live: 100 }

  - name: Request time
    graphite:
      metric: averageSeries(inn.*.kidzania.api.http.timer.all.p75)
      warn.max: { live: 15 }
      crit.max: { live: 30 }

  - name: Errors rate
    elastic:
      query: tag:"kidzania-api" AND level:ERROR
      from: 10min
      warn: 1
      crit: 10
